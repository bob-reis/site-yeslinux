name: PR Checks

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for breaking changes
      run: |
        echo "Checking for potential breaking changes..."
        git diff --name-only origin/main...HEAD | grep -E '\.(tsx?|js|jsx)$' || echo "No code changes detected"

    - name: Run linting
      run: npm run lint

    - name: Run type checking
      run: npx tsc --noEmit

    - name: Run tests
      run: npm test

    - name: Check bundle size
      run: |
        npm run build
        echo "Build completed successfully"

    - name: Comment PR with test results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          let status = '‚úÖ All checks passed!';
          if ('${{ job.status }}' !== 'success') {
            status = '‚ùå Some checks failed. Please review the logs.';
          }
          
          const comment = `
          ## üöÄ PR Validation Results
          
          ${status}
          
          ### Checks performed:
          - ‚úÖ ESLint validation
          - ‚úÖ TypeScript type checking  
          - ‚úÖ Unit tests with coverage
          - ‚úÖ Build verification
          
          **Coverage Report:** Check the test job for detailed coverage information.
          
          ---
          *This comment was automatically generated by the PR validation workflow.*
          `;
          
          github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: comment
          });

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build and analyze bundle
      run: |
        npm run build
        
        echo "üì¶ Bundle Analysis"
        echo "===================="
        
        if [ -d ".next/static" ]; then
          echo "Static files:"
          find .next/static -name "*.js" -type f -exec du -h {} + | sort -rh | head -10
          
          echo -e "\nüìä Total bundle size:"
          du -sh .next/
        else
          echo "No build output found"
        fi